# Bitget History Downloader

Bash-скрипт для скачивания и обработки исторических рыночных данных (сделок и глубины рынка) с публичного API Bitget для криптовалютных пар, таких как BTCUSDT. Скрипт создаёт локальное зеркало, конвертирует данные в CSV и сохраняет в SQLite-базу с защитой от дублирования.

## Возможности

- Поддерживает `trades` (история сделок) и `depth` (снимки книги ордеров) для спотового и фьючерсного рынков.
- Сохраняет `.zip` в `data/offline/`, чтобы не скачивать повторно.
- Конвертирует `.xlsx` (depth) в `.csv` и хранит в `data/csv/`.
- Импортирует данные в SQLite с защитой от дублирования (`trade_id` для trades, `timestamp` для depth).
- Использует SOCKS4/SOCKS5 прокси с ротацией на основе частоты скачиваний.
- Настраивается через `data/config` для чувствительных параметров, таких как прокси.
- Режим отладки (`--debug`) для подробного логирования.
- Пропускает некорректные файлы (не-Zip или не-CSV) с логированием вместо завершения.

## Требования

- Linux/Unix-окружение (например, Ubuntu, macOS).
- Зависимости:
  - `curl`: Для скачивания файлов.
  - `unzip`: Для распаковки `.zip`.
  - `sqlite3`: Для работы с базой данных.
  - `ssconvert` (из `gnumeric`): Для конвертации `.xlsx` в `.csv`.
- Установка на Ubuntu/Debian:
  ```bash
  sudo apt-get install curl unzip sqlite3 gnumeric
  ```

## Настройка

Чувствительные параметры, такие как прокси, можно задать в `data/config` (не включён в репозиторий из соображений безопасности). Создайте файл вручную при необходимости.

Пример `data/config`:
```bash
MY_PROXY="socks5://1.2.3.4:1080"
```

Если доступ к `cdn.jsdelivr.net` (для списков прокси) ограничен, укажите локальный SOCKS5-прокси в `data/config`. Пример:
```bash
MY_PROXY="socks5://1.2.3.4:1080"
```

## Установка

1. Склонируйте репозиторий:
   ```bash
   git clone https://github.com/magf/bitget-history.git
   cd bitget-history
   ```

2. Сделайте скрипты исполняемыми:
   ```bash
   chmod +x check_proxies.sh download_history.sh
   ```

3. Сгенерируйте список прокси:
   ```bash
   ./check_proxies.sh --timeout 3
   ```

## Использование

1. **Проверка прокси**:
   - Сгенерируйте список рабочих SOCKS4/SOCKS5 прокси:
     ```bash
     ./check_proxies.sh --timeout 3 --debug
     ```
   - Параметры:
     - `--timeout`: Таймаут соединения в секундах (по умолчанию: 3).
     - `--debug`: Включить подробное логирование.

2. **Скачивание истории**:
   - Запустите скрипт с параметрами для пары, типа данных, рынка и диапазона дат:
     ```bash
     ./download_history.sh --pair BTCUSDT --type depth --market spot --start-date 2024-05-01 --end-date 2024-05-02 --debug
     ```
   - Параметры:
     - `--pair`: Торговая пара (например, `BTCUSDT`). По умолчанию: `BTCUSDT`.
     - `--type`: Тип данных (`trades` или `depth`). Обязательный.
     - `--market`: Тип рынка (`spot` или `futures`). По умолчанию: `spot`.
     - `--start-date`: Начальная дата (ГГГГ-ММ-ДД). По умолчанию: год назад.
     - `--end-date`: Конечная дата (ГГГГ-ММ-ДД). По умолчанию: сегодня.
     - `--debug`: Включить подробное логирование.

### Результат

- **Списки прокси**:
  - Сырые прокси: `data/proxies_raw.txt`.
  - Рабочие прокси: `data/proxies.txt`.
- **ZIP-файлы**: Хранятся в `data/offline/` (например, `data/offline/depth/BTCUSDT/1/20240501.zip`).
- **CSV-файлы**: Хранятся в `data/csv/` (например, `data/csv/depth/BTCUSDT/20240501.csv`).
- **База данных**: SQLite-база в `data/history_<ПАРА>_<РЫНОК>.db` (например, `data/history_BTCUSDT_spot.db`).

### Пример

Скачать данные глубины для BTCUSDT (спот) с 1 по 2 мая 2024:

```bash
./check_proxies.sh --timeout 3
./download_history.sh --pair BTCUSDT --type depth --market spot --start-date 2024-05-01 --end-date 2024-05-02 --debug
```

Проверить базу:
```bash
sqlite3 data/history_BTCUSDT_spot.db "SELECT COUNT(*) FROM depth;"
```

## Схема базы данных

- **Таблица trades**:
  - `trade_id` (TEXT, PRIMARY KEY): Уникальный ID сделки.
  - `timestamp` (INTEGER): Unix-время (мс).
  - `price` (REAL): Цена сделки.
  - `side` (TEXT): Покупка или продажа.
  - `volume_quote` (REAL): Объём в котируемой валюте.
  - `size_base` (REAL): Объём в базовой валюте.
  - Индекс: `idx_trades_timestamp` на `timestamp`.

- **Таблица depth**:
  - `timestamp` (INTEGER, PRIMARY KEY): Unix-время (мс).
  - `ask_price` (REAL): Лучшая цена продажи.
  - `bid_price` (REAL): Лучшая цена покупки.
  - `ask_volume` (REAL): Объём на продажу.
  - `bid_volume` (REAL): Объём на покупку.
  - Индекс: `idx_depth_timestamp` на `timestamp`.

## Замечания

- Пропускает существующие `.zip` и `.csv` файлы, чтобы не скачивать и не конвертировать повторно.
- Файлы depth одинаковы для спота (`1`) и фьючерсов (`2`) и используются повторно, если уже скачаны.
- Временные файлы хранятся в `/tmp/` и удаляются после обработки.
- Все файлы данных (`data/`) исключены из репозитория через `.gitignore`.
- Ротация прокси происходит на основе количества скачиваний, а не ошибок, для упрощения обработки ошибок.
- Некорректные файлы (не-Zip или не-CSV) логируются и пропускаются без остановки скрипта.

## Лицензия

Проект распространяется под лицензией MIT. См. [LICENSE](LICENSE).

## Как помочь проекту

Открывайте issues или присылайте pull requests на GitHub.

## Автор

Максим Гайдай <maxim.gajdaj@gmail.com>